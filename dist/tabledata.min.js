class HeaderCell{constructor(e){this.column=e,this.settings=e.settings,this.element=document.createElement("th"),this.span=document.createElement("span"),this.name=e.field,this.direction="desc",this.directionNext="desc",this.type=e.type,e.headerCss&&this.element.classList.add(e.headerCss),this.settings.tableHeaderThCss&&this.element.classList.add(this.settings.tableHeaderThCss),e.columnSize&&this.element.classList.add(e.columnSize),e.width&&(this.element.style.width=e.width),e.headerFilterEmpty&&this.span.classList.add(e.headerFilterEmpty),this.element.appendChild(this.span),this.element.context=this,this.span.innerText=e.label,this.span.context=this}setSortFlag(){void 0===this.icon&&(this.icon=document.createElement("i"),this.span.append(this.icon)),"desc"===this.directionNext?(this.icon.classList=this.settings.tableCssSortDesc,this.direction="desc",this.directionNext="asc"):(this.icon.classList=this.settings.tableCssSortAsc,this.direction="asc",this.directionNext="desc")}removeSortFlag(){this.direction="desc",this.directionNext="desc",this.icon=this.icon.remove()}get isCurrentSort(){return void 0!==this.icon}}class CssHelper{static between={button:"tabledata-between-button",label:"tabledata-between-input-label"};static noHeader="tabledata-no-header";static input="tabledata-input";static multiSelect={parentClass:"tabledata-multi-select",header:"tabledata-multi-select-header",headerActive:"tabledata-multi-select-header-active",headerOption:"tabledata-multi-select-header-option",options:"tabledata-multi-select-options",option:"tabledata-multi-select-option",optionText:"tabledata-multi-select-option-text",optionRadio:"tabledata-multi-select-option-radio",selected:"tabledata-multi-select-selected"};static tooltip={parentClass:"tabledata-tooltip",right:"tabledata-tooltip-right",left:"tabledata-tooltip-left"}}class Column{constructor(e,t,s=0){this.settings=t,this.index=s,void 0===e.field?(this.field=`column${s}`,this.type="icon",this.label=""):(this.field=e.field,this.type=e.type?e.type:"string",this.label=e.label?e.label:e.field[0].toUpperCase()+e.field.slice(1)),e?.formatterModuleName?(this.formatter="module",this.formatterModuleName=e.formatterModuleName):(this.formatter=e.formatter,this.formatterParams=e.formatterParams),this.headerCss=e.headerCss,this.columnSize=e?.columnSize?`tabledata-col-${e.columnSize}`:"",this.width=e?.width??void 0,this.hasFilter=!("icon"===this.type||!e.filterType),this.headerCell=void 0,this.headerFilter=void 0,this.hasFilter?this.#e(e,t):e?.headerFilterEmpty&&(this.headerFilterEmpty="string"==typeof e.headerFilterEmpty?e.headerFilterEmpty:CssHelper.noHeader),e.tooltipField&&(this.tooltipField=e.tooltipField,this.tooltipLayout="right"===e?.tooltipLayout?CssHelper.tooltip.right:CssHelper.tooltip.left)}#e(e,t){this.filterElement="between"===e.filterType?"between":"input",this.filterType=e.filterType,this.filterParams=e.filterParams,this.filterCss=e?.filterCss??t.tableFilterCss,this.filterRealTime=e?.filterRealTime??!1,e.filterValues&&(this.filterValues=e.filterValues,this.filterValuesRemoteSource="string"==typeof e.filterValues?e.filterValues:void 0,this.filterElement=e.filterMultiSelect?"multi":"select",this.filterMultiSelect=e.filterMultiSelect)}}class ColumnManager{#t;#s=0;constructor(e,t){this.#t=[],this.settings=t,this.tableEvenColumnWidths=t.tableEvenColumnWidths,this.hasHeaderFilters=!1;for(const s of e){const e=new Column(s,t,this.#s);e.headerCell=new HeaderCell(e),this.#t.push(e),this.#s++}this.#t.some(e=>e.hasFilter)&&(this.hasHeaderFilters=!0),t.tableEvenColumnWidths&&this.#i()}#i(){const e=this.#t.filter(e=>void 0===e.width).length,t=this.#t.filter(e=>void 0!==e.width).map(e=>e.width);let s=0;for(const e of t)"string"==typeof e&&e.includes("%")&&(s+=parseFloat(e.replace("%","")));const i=(100-s)/e;for(const e of this.#t)e.headerCell.element.style.width||(e.headerCell.element.style.width=`${i}%`)}get columns(){return this.#t}addColumn(e,t=null){const s=new Column(e,this.settings,this.#s);s.headerCell=new HeaderCell(s),null!==t&&t>=0&&t<this.#t.length?this.#t.splice(t,0,s):this.#t.push(s),this.#s++,this.tableEvenColumnWidths&&this.#i()}}class DataPipeline{#n;constructor(e){this.#n={},this.ajaxUrl=e.ajaxUrl}countEventSteps(e){return this.#n[e]?this.#n[e].length:0}hasPipeline(e){return!!this.#n[e]&&this.#n[e].length>0}addStep(e,t,s=""){if(this.#n[e]){if(this.#n[e].some(e=>e.callback===t))return void console.warn("Callback function already found for: "+e)}else this.#n[e]=[];""===s&&(s=this.ajaxUrl),this.#n[e].push({url:s,callback:t})}async execute(e){for(let t of this.#n[e])try{const e=await fetch(t.url,{method:"GET",mode:"cors",headers:{Accept:"application/json"}});if(e.ok){const s=await e.json();t.callback(s)}}catch(e){window.alert(e.message),console.log(e.message);break}}}class DataLoader{constructor(e){this.ajaxUrl=e.ajaxUrl}buildUrl(e,t={}){const s=Object.keys(t);if(0===s.length)return e;let i=[];for(const e of s)if(Array.isArray(t[e])){const s=t[e].map(t=>`${e}=${encodeURIComponent(t)}`);i=i.concat(s)}else i.push(`${e}=${encodeURIComponent(t[e])}`);return-1!==e.indexOf("?")?`${e}&${i.join("&")}`:`${e}?${i.join("&")}`}async requestData(e,t={}){let s=[];const i=this.buildUrl(e,t);try{const e=await fetch(i,{method:"GET",mode:"cors",headers:{Accept:"application/json"}});e.ok&&(s=await e.json())}catch(e){window.alert(e.message),console.log(e.message),s=[]}return s}async requestGridData(e={}){return this.requestData(this.ajaxUrl,e)}}class DataPersistence{constructor(e){this.data=e,this.dataCache=e.length>0?structuredClone(e):[]}get rowCount(){return this.data.length}setData=e=>{if(!Array.isArray(e))return this.data=[],void(this.dataCache=[]);this.data=e,this.dataCache=e.length>0?structuredClone(e):[]};restoreData(){this.data=structuredClone(this.dataCache)}}class GridEvents{#r;constructor(){this.#r={}}#a(e){return!!this.#r&&this.#r[e]}subscribe(e,t,s=!1,i=0){this.#r[e]?(this.#r[e].push({handler:t,priority:i,isAsync:s}),this.#r[e].sort((e,t)=>e.priority-t.priority)):this.#r[e]=[{handler:t,priority:i,isAsync:s}]}unsubscribe(e,t){this.#a(e)&&(this.#r[e]=this.#r[e].filter(e=>e.handler!==t))}chain(e,t={}){if(!this.#a(e))return;let s=t;return this.#r[e].forEach(e=>{s=e.handler(s)}),s}async trigger(e,...t){if(this.#a(e))for(let s of this.#r[e])s.isAsync?await s.handler(...t):s.handler(...t)}}class DateHelper{static timeReGex=new RegExp("[0-9]:[0-9]");static parseDate(e){this.timeReGex.test(e)||(e=`${e}T00:00`);const t=new Date(e);return Number.isNaN(t.valueOf())?"":t}static parseDateOnly(e){const t=this.parseDate(e);return""===t?"":(t.setHours(0,0,0,0),t)}static isDate(e){return"[object Date]"===Object.prototype.toString.call(e)}}class FormatDateTime{static monthsLong=["January","February","March","April","May","June","July","August","September","October","November","December"];static monthsShort=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];static leadingZero(e){return e<10?"0"+e:e}static apply(e,t,s="MM/dd/yyyy",i=!1){let n=t?.formatterParams?.format??s,r=t?.formatterParams?.dateField?e[t.formatterParams.dateField]:e[t.field];if(null===r)return"";const a=DateHelper.parseDate(r);if(""===a)return"";let l={d:a.getDate(),dd:this.leadingZero(a.getDate()),M:a.getMonth()+1,MM:this.leadingZero(a.getMonth()+1),MMM:this.monthsShort[a.getMonth()],MMMM:this.monthsLong[a.getMonth()],yy:a.getFullYear().toString().slice(-2),yyyy:a.getFullYear()};if(i){let e=a.getHours(),t=e%12==0?12:e%12;l.s=a.getSeconds(),l.ss=this.leadingZero(a.getSeconds()),l.m=a.getMinutes(),l.mm=this.leadingZero(a.getMinutes()),l.h=t,l.hh=this.leadingZero(t),l.H=e,l.HH=this.leadingZero(e),l.hp=e<12?"AM":"PM"}const o=n.split(/\/|-|\s|:/);for(let e of o)n=n.replace(e,l[e]);return n}}class FormatLink{static apply(e,t){const s=document.createElement("a");let i=t.urlPrefix;if(t.routeField&&(i+="/"+encodeURIComponent(e[t.routeField])),t.queryField){const s=encodeURIComponent(e[t.queryField]);i=`${i}?${t.queryField}=${s}`}return s.href=i,t.fieldText?s.innerHTML=e[t.fieldText]:"function"==typeof t.innerText?s.innerHTML=t.innerText(e,t):t.innerText&&(s.innerHTML=t.innerText),t.target&&(s.setAttribute("target",t.target),s.setAttribute("rel","noopener")),s}}class FormatNumeric{static apply(e,t,s="decimal"){const i=e[t.field];if(isNaN(i))return i;const n=t.formatterParams?.precision??2;return new Intl.NumberFormat("en-US",{style:s,maximumFractionDigits:n,currency:"USD"}).format(i)}}class FormatStar{static apply(e,t){let s=e[t.field];const i=t.formatterParams?.stars?t.formatterParams.stars:5,n=document.createElement("div"),r=document.createElement("span"),a=document.createElementNS("http://www.w3.org/2000/svg","svg");r.style.verticalAlign="middle",a.setAttribute("width","14"),a.setAttribute("height","14"),a.setAttribute("viewBox","0 0 512 512"),a.setAttribute("xml:space","preserve"),a.style.padding="0 1px",s=s&&!isNaN(s)?parseInt(s):0,s=Math.max(0,Math.min(s,i));for(let e=1;e<=i;e++){const t=a.cloneNode(!0);t.innerHTML=e<=s?'<polygon fill="#FFEA00" stroke="#C1AB60" stroke-width="37.6152" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" points="259.216,29.942 330.27,173.919 489.16,197.007 374.185,309.08 401.33,467.31 259.216,392.612 117.104,467.31 144.25,309.08 29.274,197.007 188.165,173.919 "/>':'<polygon fill="#D2D2D2" stroke="#686868" stroke-width="37.6152" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" points="259.216,29.942 330.27,173.919 489.16,197.007 374.185,309.08 401.33,467.31 259.216,392.612 117.104,467.31 144.25,309.08 29.274,197.007 188.165,173.919 "/>',r.appendChild(t)}return n.style.whiteSpace="nowrap",n.style.overflow="hidden",n.style.textOverflow="ellipsis",n.setAttribute("aria-label",s),n.append(r),n}}class Cell{static#l={link:(e,t,s)=>{s.append(FormatLink.apply(e,t.formatterParams))},date:(e,t,s)=>{s.innerText=FormatDateTime.apply(e,t,t.settings.dateFormat,!1)},datetime:(e,t,s)=>{s.innerText=FormatDateTime.apply(e,t,t.settings.dateTimeFormat,!0)},decimal:(e,t,s)=>{s.innerText=FormatNumeric.apply(e,t,"decimal")},money:(e,t,s)=>{s.innerText=FormatNumeric.apply(e,t,"currency")},percent:(e,t,s)=>{s.innerText=FormatNumeric.apply(e,t,"percent")},star:(e,t,s)=>{s.append(FormatStar.apply(e,t))}};constructor(e,t,s,i){this.element=document.createElement("td"),t.formatter?this.#o(e,t,s,i):this.#c(e,t),t.tooltipField&&this.#h(e[t.tooltipField],t.tooltipLayout)}#c(e,t){this.element.innerText=e[t.field]??""}#h(e,t){if(null===e||""===e)return;let s=this.element.firstElementChild;null===s&&(s=document.createElement("span"),s.innerText=this.element.innerText,this.element.replaceChildren(s)),s.dataset.tooltip=e,s.classList.add(CssHelper.tooltip.parentClass,t)}#o(e,t,s,i){if("function"==typeof t.formatter)return void this.element.append(t.formatter(e,t.formatterParams,this.element,i));if("module"===t.formatter){const n=t.formatterModuleName;return s?.[n]?void this.element.append(s[n].apply(e,t,i,this.element)):(console.warn(`Formatter module "${n}" not found`),void this.#c(e,t))}const n=Cell.#l[t.formatter];n?n(e,t,this.element):this.#c(e,t)}}class Table{#d;constructor(e){if(this.context=e,this.table=document.createElement("table"),this.thead=document.createElement("thead"),this.tbody=document.createElement("tbody"),this.#d=0,this.table.id=`${e.settings.baseIdName}_table`,this.table.append(this.thead,this.tbody),this.table.className=e.settings.tableCss,e.settings.tableStyleSettings&&"object"==typeof e.settings.tableStyleSettings)for(const[t,s]of Object.entries(e.settings.tableStyleSettings))this.table.style[t]=s}initializeHeader(){const e=document.createElement("tr");for(const t of this.context.columnManager.columns)e.appendChild(t.headerCell.element);this.thead.appendChild(e)}renderRows(e,t=null){if(this.tbody.replaceChildren(),Array.isArray(e)){this.#d=t??e.length;for(const t of e){const e=document.createElement("tr");for(let s of this.context.columnManager.columns){const i=new Cell(t,s,this.context.modules,e);e.appendChild(i.element)}this.tbody.appendChild(e)}}else this.#d=0}get rowCount(){return this.#d}}class GridContext{constructor(e,t,s=[]){this.settings=t,this.events=new GridEvents,this.pipeline=new DataPipeline(this.settings),this.dataloader=new DataLoader(this.settings),this.persistence=new DataPersistence(s),this.columnManager=new ColumnManager(e,this.settings),this.grid=new Table(this),this.modules={}}}const settingsDefaults={baseIdName:"tabledata",data:[],columns:[],enablePaging:!0,pagerPagesToDisplay:5,pagerRowsPerPage:25,pagerCss:"tabledata-pager",dateFormat:"MM/dd/yyyy",dateTimeFormat:"MM/dd/yyyy HH:mm:ss",remoteUrl:"",remoteParams:"",remoteProcessing:!1,tableCss:"tabledata",tableStyleSettings:"",tableHeaderThCss:"",tableFilterCss:"tabledata-input",tableEvenColumnWidths:!1,tableCssSortAsc:"tabledata-sort-icon tabledata-sort-asc",tableCssSortDesc:"tabledata-sort-icon tabledata-sort-desc",refreshableId:"",rowCountId:"",csvExportId:"",csvExportRemoteSource:""};class MergeOptions{static merge(e){let t=JSON.parse(JSON.stringify(settingsDefaults));if(void 0===e||0===Object.keys(e).length)return t;for(let[s,i]of Object.entries(e)){let e=void 0!==t[s]?t[s].toString():void 0,n=i.toString();void 0!==e&&e!==n&&(t[s]=i)}return t}}class SettingsGrid{constructor(e){if(this.baseIdName=e.baseIdName,this.enablePaging=e.enablePaging,this.pagerPagesToDisplay=e.pagerPagesToDisplay,this.pagerRowsPerPage=e.pagerRowsPerPage,this.dateFormat=e.dateFormat,this.dateTimeFormat=e.dateTimeFormat,this.remoteUrl=e.remoteUrl,this.remoteParams=e.remoteParams,this.remoteProcessing=!1,this.ajaxUrl=this.remoteUrl&&this.remoteParams?this._buildAjaxUrl(this.remoteUrl,this.remoteParams):this.remoteUrl,"boolean"==typeof e.remoteProcessing&&e.remoteProcessing){const t=e.columns.find(e=>void 0!==e.field);this.remoteProcessing=!0,this.remoteSortDefaultColumn=t.field,this.remoteSortDefaultDirection="desc"}else Object.keys(e.remoteProcessing).length>0&&(this.remoteProcessing=!0,this.remoteSortDefaultColumn=e.remoteProcessing.column,this.remoteSortDefaultDirection=e.remoteProcessing.direction??"desc");this.tableCss=e.tableCss,this.tableHeaderThCss=e.tableHeaderThCss,this.tableStyleSettings=e.tableStyleSettings,this.pagerCss=e.pagerCss,this.tableFilterCss=e.tableFilterCss,this.tableEvenColumnWidths=e.tableEvenColumnWidths,this.tableCssSortAsc=e.tableCssSortAsc,this.tableCssSortDesc=e.tableCssSortDesc,this.refreshableId=e.refreshableId,this.rowCountId=e.rowCountId,this.csvExportId=e.csvExportId,this.csvExportRemoteSource=e.csvExportRemoteSource}_buildAjaxUrl(e,t){const s=Object.keys(t);if(s.length>0){return`${e}?${s.map(e=>`${encodeURIComponent(e)}=${encodeURIComponent(t[e])}`).join("&")}`}return e}}class RowModule{constructor(e){this.context=e}initialize(){this.context.settings.remoteProcessing?this.context.events.subscribe("render",this.renderRemote,!0,10):this.context.events.subscribe("render",this.renderLocal,!1,10)}renderLocal=()=>{this.context.grid.renderRows(this.context.persistence.data)};renderRemote=async()=>{const e=this.context.events.chain("remoteParams",{}),t=await this.context.dataloader.requestGridData(e);this.context.grid.renderRows(t)}}RowModule.moduleName="row";class PagerButtons{static start(e,t){const s=document.createElement("li"),i=document.createElement("button");return s.append(i),i.innerHTML="&lsaquo;",i.addEventListener("click",t),e>1?i.dataset.page="1":(i.tabIndex=-1,i.disabled=!0,s.className="disabled"),s}static end(e,t,s){const i=document.createElement("li"),n=document.createElement("button");return i.append(n),n.innerHTML="&rsaquo;",n.addEventListener("click",s),t<e?n.dataset.page=e:(n.tabIndex=-1,n.disabled=!0,i.className="disabled"),i}static pageNumber(e,t,s){const i=document.createElement("li"),n=document.createElement("button");return i.append(n),n.innerText=e,n.dataset.page=e,n.addEventListener("click",s),e===t&&(i.className="active"),i}}class PagerModule{constructor(e){this.context=e,this.totalRows=this.context.persistence.rowCount,this.pagesToDisplay=this.context.settings.pagerPagesToDisplay,this.rowsPerPage=this.context.settings.pagerRowsPerPage,this.currentPage=1,this.container=document.createElement("div"),this.elPager=document.createElement("ul"),this.container.id=`${this.context.settings.baseIdName}_pager`,this.container.className=this.context.settings.pagerCss,this.container.append(this.elPager),this.context.grid.table.insertAdjacentElement("afterend",this.container)}initialize(){this.context.settings.remoteProcessing?this.context.events.subscribe("render",this.renderRemote,!0,10):this.context.events.subscribe("render",this.renderLocal,!1,10)}totalPages(){const e=isNaN(this.totalRows)?1:this.totalRows;return 0===this.rowsPerPage?1:Math.ceil(e/this.rowsPerPage)}validatePage(e){Number.isInteger(e)||(e=parseInt(e));const t=this.totalPages(),s=t<e?t:e;return s<=0?1:s}firstDisplayPage(e){const t=Math.floor(this.pagesToDisplay/2+this.pagesToDisplay%2);return e<t?1:this.totalPages()<e+this.pagesToDisplay-t?Math.max(this.totalPages()-this.pagesToDisplay+1,1):e-t+1}render(e,t){const s=this.totalPages();if(this.elPager.replaceChildren(),s<=1)return;const i=this.firstDisplayPage(e),n=i+this.pagesToDisplay;this.currentPage=e,this.elPager.appendChild(PagerButtons.start(e,t));for(let r=i;r<=s&&r<n;r++)this.elPager.appendChild(PagerButtons.pageNumber(r,e,t));this.elPager.appendChild(PagerButtons.end(s,e,t))}handlePaging=async e=>{const t={page:this.validatePage(e.currentTarget.dataset.page)};this.context.settings.remoteProcessing?await this.renderRemote(t):this.renderLocal(t)};renderLocal=(e={})=>{const t=e.page?this.validatePage(e.page):1,s=(t-1)*this.rowsPerPage,i=s+this.rowsPerPage,n=this.context.persistence.data.slice(s,i);this.context.grid.renderRows(n,this.context.persistence.rowCount),this.totalRows=this.context.persistence.rowCount,this.render(t,this.handlePaging)};renderRemote=async(e={})=>{e.page||(e.page=1),e=this.context.events.chain("remoteParams",e);const t=await this.context.dataloader.requestGridData(e),s=t.rowCount??0;this.context.grid.renderRows(t.data,s),this.totalRows=s,this.render(e.page,this.handlePaging)}}PagerModule.moduleName="pager";class GridCore{#u;#m;constructor(e,t){const s=MergeOptions.merge(t);if(this.settings=new SettingsGrid(s),this.container=document.getElementById(e),this.enablePaging=this.settings.enablePaging,this.isValid=!0,this.#u=[],this.#m=!1,this.modules={},0===Object.values(s.columns).length)console.log("Missing required columns definition."),this.isValid=!1;else{const e=s.data??[];this.#p(s.columns,e)}}#p(e,t){this.context=new GridContext(e,this.settings,t),this.container.append(this.context.grid.table)}addModules(...e){e.forEach(e=>this.#u.push(e))}addColumn(e,t=null){this.context.columnManager.addColumn(e,t)}_initModules=async()=>{this.#m||(this.settings.enablePaging&&!this.#u.some(e=>"page"===e.moduleName)?this.#u.push(PagerModule):this.#u.some(e=>"row"===e.moduleName)||this.#u.push(RowModule),this.#u.forEach(e=>{this.context.modules[e.moduleName]=new e(this.context),this.context.modules[e.moduleName].initialize()}),this.#m=!0,await this.context.events.trigger("postInitMod"))};async init(){this.isValid?(this.context.grid.initializeHeader(),await this._initModules(),!this.settings.remoteProcessing&&this.settings.remoteUrl&&this.context.pipeline.addStep("init",this.context.persistence.setData),this.context.pipeline.hasPipeline("init")&&await this.context.pipeline.execute("init"),await this.context.events.trigger("render")):console.log("Missing required columns definition.")}setFilter=async(e,t,s="equals",i="string",n={})=>{this.context.modules.filter?(this.context.modules.filter.setFilter(e,t,s,i,n),await this.context.events.trigger("render")):console.warn("Filter module is not enabled.  Set `TableData.defaultOptions.enableFilter` to true in order to enable this function.")};removeFilter=async e=>{this.context.modules.filter?(this.context.modules.filter.removeFilter(e),await this.context.events.trigger("render")):console.warn("Filter module is not enabled.  Set `TableData.defaultOptions.enableFilter` to true in order to enable this function.")}}class CsvModule{constructor(e){this.context=e,this.delimiter=",",this.button=e.settings.csvExportId,this.dataUrl=e.settings.csvExportRemoteSource}initialize(){document.getElementById(this.button).addEventListener("click",this.handleDownload)}handleDownload=async()=>{let e=[];const t=`${document.title}.csv`;if(this.dataUrl){const t=await this.context.dataloader.requestData(this.dataUrl);e=this.buildFileContent(t).join("\r\n")}else e=this.buildFileContent(this.context.persistence.dataCache).join("\r\n");const s=new Blob([e],{type:"text/csv;charset=utf-8;"}),i=document.createElement("a");i.setAttribute("href",window.URL.createObjectURL(s)),i.setAttribute("download",t),i.style.display="none",document.body.appendChild(i),i.click(),document.body.removeChild(i),window.alert(`Downloaded ${t}`)};identifyColumns(e){const t=[],s=[];for(const i of e)"icon"!==i.type&&(t.push(i.label),s.push(i));return{headers:t,columns:s}}buildFileContent(e){const t=[],s=this.identifyColumns(this.context.columnManager.columns);t.push(s.headers.join(this.delimiter));for(const i of e){const e=s.columns.map(e=>this.formatValue(e,i));t.push(e.join(this.delimiter))}return t}formatValue(e,t){let s=String(t[e.field]);return e.formatter&&("function"==typeof e.formatter?s=String(e.formatter(t,e.formatterParams)):"module"===e.formatter&&(s=String(this.context.modules[e.formatterModuleName].applyCsv(t,e)))),s.includes(",")&&(s=`"${s}"`),s}}CsvModule.moduleName="csv";class FilterTarget{constructor(e){this.value=e.value,this.field=e.field,this.fieldType=e.fieldType||"string",this.filterType=e.filterType,this.filters=this.#p()}#p(){return{equals:function(e,t){return e===t},like:function(e,t){return null!=t&&""!==t&&String(t).toLowerCase().indexOf(e.toLowerCase())>-1},"<":function(e,t){return e<t},"<=":function(e,t){return e<=t},">":function(e,t){return e>t},">=":function(e,t){return e>=t},"!=":function(e,t){return t!==e},between:function(e,t){return t>=e[0]&&t<=e[1]},in:function(e,t){return Array.isArray(e)?!e.length||e.indexOf(t)>-1:(console.warn("Filter Error - filter value is not an array:",e),!1)}}}execute(e,t){return this.filters[this.filterType](this.value,e)}}class FilterDate{constructor(e){this.value=e.value,this.field=e.field,this.fieldType="date",this.filterType=e.filterType,this.filters=this.#p()}cloneDates=(e,t)=>{const s=new Date(e),i=new Date(t);return s.setHours(0,0,0,0),i.setHours(0,0,0,0),[s,i]};#p(){return{equals:function(e,t){return e.getFullYear()===t.getFullYear()&&e.getMonth()===t.getMonth()&&e.getDate()===t.getDate()},"<":(e,t)=>{const s=this.cloneDates(e,t);return s[0].getTime()<s[1].getTime()},"<=":(e,t)=>{const s=this.cloneDates(e,t);return s[0].getTime()<s[1].getTime()},">":(e,t)=>{const s=this.cloneDates(e,t);return s[0].getTime()>s[1].getTime()},">=":(e,t)=>{const s=this.cloneDates(e,t);return s[0].getTime()>=s[1].getTime()},"!=":function(e,t){return e.getFullYear()!==t.getFullYear()&&e.getMonth()!==t.getMonth()&&e.getDate()!==t.getDate()},between:(e,t)=>{const s=this.cloneDates(e[0],e[1]),i=this.cloneDates(t,t);return i[0]>=s[0]&&i[0]<=s[1]}}}execute(e,t){return!(null===e||!DateHelper.isDate(e))&&this.filters[this.filterType](this.value,e)}}class FilterFunction{constructor(e){this.value=e.value,this.field=e.field,this.filterFunction=e.filterType,this.params=e.params??{}}execute(e,t){return this.filterFunction(this.value,e,t,this.params)}}class ElementHelper{static create(e,t={},s={}){const i=Object.assign(document.createElement(e),t);return s&&Object.assign(i.dataset,s),i}static div(e={},t={}){return this.create("div",e,t)}static input(e={},t={}){return this.create("input",e,t)}static span(e={},t={}){return this.create("span",e,t)}}class ElementBetween{constructor(e,t){this.context=t,this.element=ElementHelper.div({name:e.field,className:CssHelper.multiSelect.parentClass}),this.header=ElementHelper.div({className:CssHelper.multiSelect.header}),this.optionsContainer=ElementHelper.div({className:CssHelper.multiSelect.options}),this.field=e.field,this.fieldType=e.type,this.filterType="between",this.element.id=`${this.context.settings.baseIdName}_${this.field}`,this.element.append(this.header,this.optionsContainer),this.header.id=`header_${this.context.settings.baseIdName}_${this.field}`,this.optionsContainer.style.minWidth="185px",this.#g(),this.header.addEventListener("click",this.handleClick)}#g(){this.elementStart=ElementHelper.input({className:CssHelper.input,id:`start_${this.context.settings.baseIdName}_${this.field}`}),this.elementEnd=ElementHelper.input({className:CssHelper.input,id:`end_${this.context.settings.baseIdName}_${this.field}`}),this.elementEnd.style.marginBottom="10px";const e=ElementHelper.span({innerText:"Start",className:CssHelper.between.label}),t=ElementHelper.span({innerText:"End",className:CssHelper.between.label}),s=ElementHelper.create("button",{innerText:"Apply",className:CssHelper.between.button});s.style.marginRight="10px",s.addEventListener("click",this.handleClick);const i=ElementHelper.create("button",{innerText:"Clear",className:CssHelper.between.button});i.addEventListener("click",this.handleButtonClear),this.optionsContainer.append(e,this.elementStart,t,this.elementEnd,s,i)}handleButtonClear=()=>{this.elementStart.value="",this.elementEnd.value="",void 0!==this.countLabel&&(this.countLabel.remove(),this.countLabel=void 0)};createCountLabel=()=>{void 0===this.countLabel&&(this.countLabel=document.createElement("span"),this.countLabel.className=CssHelper.multiSelect.headerOption,this.header.append(this.countLabel)),""!==this.elementStart.value&&""!==this.elementEnd.value?this.countLabel.innerText=`${this.elementStart.value} to ${this.elementEnd.value}`:(this.countLabel.remove(),this.countLabel=void 0)};handleClick=async()=>{this.header.classList.toggle(CssHelper.multiSelect.headerActive)?document.addEventListener("click",this.handleDocument):(this.createCountLabel(),await this.context.events.trigger("render"),document.removeEventListener("click",this.handleDocument))};handleDocument=async e=>{e.target.closest(`.${CssHelper.input}`)||e.target.closest(`#${this.header.id}`)||(this.header.classList.remove(CssHelper.multiSelect.headerActive),await this.context.events.trigger("render"),document.removeEventListener("click",this.handleDocument))};get value(){return""===this.elementStart.value||""===this.elementEnd.value?"":[this.elementStart.value,this.elementEnd.value]}}class ElementInput{constructor(e,t){this.element=document.createElement("input"),this.context=t,this.field=e.field,this.fieldType=e.type,this.filterType=e.filterType,this.filterIsFunction="function"==typeof e?.filterType,this.filterParams=e.filterParams,this.element.name=this.field,this.element.id=this.field,this.element.addEventListener("change",async()=>await this.context.events.trigger("render")),e.filterCss&&(this.element.className=e.filterCss),!this.context.settings.remoteProcessing&&e.filterRealTime&&(this.realTimeTimeout="number"==typeof this.filterRealTime?this.filterRealTime:500,this.element.addEventListener("keyup",this.handleLiveFilter))}handleLiveFilter=async()=>{setTimeout(async()=>await this.context.events.trigger("render"),this.realTimeTimeout)};get value(){return this.element.value}}class ElementMultiSelect{constructor(e,t){if(this.context=t,this.element=ElementHelper.div({name:e.field,className:CssHelper.multiSelect.parentClass}),this.header=ElementHelper.div({className:CssHelper.multiSelect.header}),this.optionsContainer=ElementHelper.div({className:CssHelper.multiSelect.options}),this.field=e.field,this.fieldType=e.type,this.filterType="in",this.filterIsFunction="function"==typeof e?.filterType,this.filterParams=e.filterParams,this.listAll=!1,this.selectedValues=[],"object"==typeof e.filterMultiSelect&&(this.listAll=e.filterMultiSelect.listAll),this.header.id=`header_${this.context.settings.baseIdName}_${this.field}`,this.element.id=`${this.context.settings.baseIdName}_${this.field}`,this.element.append(this.header,this.optionsContainer),e.filterValuesRemoteSource)this.context.pipeline.addStep("init",this.templateContainer,e.filterValuesRemoteSource),this.context.pipeline.addStep("refresh",this.refreshSelectOptions,e.filterValuesRemoteSource);else{const t=Array.isArray(e.filterValues)?e.filterValues:Object.entries(e.filterValues).map(([e,t])=>({value:e,text:t}));this.templateContainer(t)}this.header.addEventListener("click",this.handleClick)}handleClick=async()=>{this.header.classList.toggle(CssHelper.multiSelect.headerActive)?document.addEventListener("click",this.handleDocument):(await this.context.events.trigger("render"),document.removeEventListener("click",this.handleDocument))};handleDocument=async e=>{e.target.closest("."+CssHelper.multiSelect.option)||e.target.closest(`#${this.header.id}`)||(this.header.classList.remove(CssHelper.multiSelect.headerActive),await this.context.events.trigger("render"),document.removeEventListener("click",this.handleDocument))};createCountLabel=()=>{void 0===this.countLabel&&(this.countLabel=document.createElement("span"),this.countLabel.className=CssHelper.multiSelect.headerOption,this.header.append(this.countLabel)),this.selectedValues.length>0?this.countLabel.innerText=`${this.selectedValues.length} selected`:(this.countLabel.remove(),this.countLabel=void 0)};handleOption=e=>{if(e.currentTarget.classList.contains(CssHelper.multiSelect.selected)){if(e.currentTarget.classList.remove(CssHelper.multiSelect.selected),e.currentTarget.dataset.selected="false",this.selectedValues=this.selectedValues.filter(t=>t!==e.currentTarget.dataset.value),this.listAll){const t=this.header.querySelector(`[data-value='${e.currentTarget.dataset.value}']`);null!==t&&t.remove()}}else if(e.currentTarget.classList.add(CssHelper.multiSelect.selected),e.currentTarget.dataset.selected="true",this.selectedValues.push(e.currentTarget.dataset.value),this.listAll){const t=ElementHelper.span({className:CssHelper.multiSelect.headerOption,innerText:e.currentTarget.dataset.value},{value:e.currentTarget.dataset.value});this.header.append(t)}!1===this.listAll&&this.createCountLabel()};createOption(e){const t=ElementHelper.div({className:CssHelper.multiSelect.option},{value:e.value,selected:"false"}),s=ElementHelper.span({className:CssHelper.multiSelect.optionRadio}),i=ElementHelper.span({className:CssHelper.multiSelect.optionText,innerHTML:e.text});return t.addEventListener("click",this.handleOption),t.append(s,i),t}templateContainer=e=>{for(const t of e){const e=this.createOption(t);this.optionsContainer.append(e)}};refreshSelectOptions=e=>{this.optionsContainer.replaceChildren(),this.header.replaceChildren(),this.countLabel=void 0;const t=[];for(const s of e){const e=this.createOption(s);if(this.selectedValues.includes(s.value)&&(e.classList.add(CssHelper.multiSelect.selected),e.dataset.selected="true",t.push(s.value),this.listAll)){const e=ElementHelper.span({className:CssHelper.multiSelect.headerOption,innerText:s.value},{value:s.value});this.header.append(e)}this.optionsContainer.append(e)}this.selectedValues=t,!1===this.listAll&&this.createCountLabel()};get value(){return this.selectedValues}}class ElementSelect{constructor(e,t){if(this.element=ElementHelper.create("select",{name:e.field}),this.field=e.field,this.fieldType=e.type,this.filterType=e.filterType,this.filterIsFunction="function"==typeof e?.filterType,this.filterParams=e.filterParams,this.pipeline=t.pipeline,this.context=t,this.element.id=`${e.settings.baseIdName}_${this.field}`,this.element.addEventListener("change",async()=>await this.context.events.trigger("render")),e.filterCss&&(this.element.className=e.filterCss),e.filterValuesRemoteSource)return this.pipeline.addStep("init",this.createSelectOptions,e.filterValuesRemoteSource),void this.pipeline.addStep("refresh",this.refreshSelectOptions,e.filterValuesRemoteSource);const s=Array.isArray(e.filterValues)?e.filterValues:Object.entries(e.filterValues).map(([e,t])=>({value:e,text:t}));this.createSelectOptions(s)}createSelectOptions=e=>{const t=ElementHelper.create("option",{value:"",text:"Select all"});this.element.append(t);for(const t of e){const e=ElementHelper.create("option",{value:t.value,text:t.text});this.element.append(e)}};refreshSelectOptions=e=>{const t=this.element.value;this.element.replaceChildren(),this.createSelectOptions(e),this.element.value=t};get value(){return this.element.value}}class FilterModule{constructor(e){this.context=e,this.headerFilters=[],this.gridFilters=[]}initialize(){this.context.settings.remoteProcessing?this.context.events.subscribe("remoteParams",this.remoteParams,!0):this.context.events.subscribe("render",this.renderLocal,!1,8),this._init()}_init(){for(const e of this.context.columnManager.columns)e.hasFilter&&("multi"===e.filterElement?e.headerFilter=new ElementMultiSelect(e,this.context):"between"===e.filterElement?e.headerFilter=new ElementBetween(e,this.context):"select"===e.filterElement?e.headerFilter=new ElementSelect(e,this.context):e.headerFilter=new ElementInput(e,this.context),e.headerCell.element.appendChild(e.headerFilter.element),this.headerFilters.push(e.headerFilter))}remoteParams=e=>{if(this.headerFilters.forEach(t=>{""!==t.value&&(e[t.field]=t.value)}),this.gridFilters.length>0)for(const t of this.gridFilters)e[t.field]=t.value;return e};convertToType(e,t){if(""===e||null===e)return e;if(Array.isArray(e)){if("date"===t||"datetime"===t){const t=e.map(e=>DateHelper.parseDate(e));return t.includes("")?null:t}if("number"===t){const s=this.convertToType(e[0],t),i=this.convertToType(e[1],t);return null===s||null===i?null:[s,i]}return e}return"number"===t?(e=Number(e),Number.isNaN(e)?null:e):("date"===t||"datetime"===t)&&""===(e=DateHelper.parseDateOnly(e))?null:e}createFilterTarget(e,t,s,i,n,r){if(n)return new FilterFunction({value:e,field:t,filterType:s,params:r});const a=this.convertToType(e,i);return null===a?null:"date"===i||"datetime"===i?new FilterDate({value:a,field:t,filterType:s}):new FilterTarget({value:a,field:t,fieldType:i,filterType:s})}compileFilters(){let e=[];for(const t of this.headerFilters){if(""===t.value)continue;const s=this.createFilterTarget(t.value,t.field,t.filterType,t.fieldType,t.filterIsFunction,t?.filterParams);null!==s&&e.push(s)}return this.gridFilters.length>0&&(e=e.concat(this.gridFilters)),e}applyFilters(e){this.context.persistence.data=[],this.context.persistence.dataCache.forEach(t=>{let s=!0;for(let i of e){const e=this.convertToType(t[i.field],i.fieldType);i.execute(e,t)||(s=!1)}s&&this.context.persistence.data.push(t)})}renderLocal=()=>{const e=this.compileFilters();Object.keys(e).length>0?this.applyFilters(e):this.context.persistence.restoreData()};setFilter(e,t,s="equals",i="string",n={}){const r=this.convertToType(t,i);if(this.gridFilters.length>0){const t=this.gridFilters.findIndex(t=>t.field===e);if(t>-1)return void(this.gridFilters[t].value=r)}const a=this.createFilterTarget(r,e,s,i,"function"==typeof s,n);this.gridFilters.push(a)}removeFilter(e){this.gridFilters=this.gridFilters.filter(t=>t.field!==e)}}FilterModule.moduleName="filter";class RefreshModule{constructor(e){this.context=e}initialize(){!this.context.settings.remoteProcessing&&this.context.settings.remoteUrl&&this.context.pipeline.addStep("refresh",this.context.persistence.setData);document.getElementById(this.context.settings.refreshableId).addEventListener("click",this.handleRefresh)}handleRefresh=async()=>{this.context.pipeline.hasPipeline("refresh")&&await this.context.pipeline.execute("refresh"),await this.context.events.trigger("render")}}RefreshModule.moduleName="refresh";class RowCountModule{constructor(e){this.context=e,this.element=document.getElementById(e.settings.rowCountId)}initialize(){this.context.events.subscribe("render",this.handleCount,!1,20)}handleCount=()=>{this.element.innerText=this.context.grid.rowCount}}RowCountModule.moduleName="rowcount";const date=(e,t,s)=>{let i=0,n=new Date(e),r=new Date(t);return Number.isNaN(n.valueOf())&&(n=null),Number.isNaN(r.valueOf())&&(r=null),null===n&&null===r?0:(n?r?n>r?i=1:n<r&&(i=-1):i=1:i=r?-1:0,"desc"===s?-1*i:i)},number=(e,t,s)=>{let i=0;return e>t?i=1:e<t&&(i=-1),"desc"===s?-1*i:i},string=(e,t,s)=>{let i=0;if(e)if(t){const s=e.toUpperCase(),n=t.toUpperCase();s>n?i=1:s<n&&(i=-1)}else i=1;else i=t?-1:0;return"desc"===s?-1*i:i};class SortModule{constructor(e){this.context=e,this.headerCells=[],this.currentSortColumn="",this.currentDirection="",this.currentType="",this.isRemote=!1}initialize(){this.isRemote=this.context.settings.remoteProcessing,this.isRemote?(this.currentSortColumn=this.context.settings.remoteSortDefaultColumn,this.currentDirection=this.context.settings.remoteSortDefaultDirection,this.context.events.subscribe("remoteParams",this.remoteParams,!0)):(this.context.events.subscribe("render",this.renderLocal,!1,9),this.sorters={number:number,string:string,date:date,datetime:date}),this.initializeHeaderCells()}initializeHeaderCells(){for(const e of this.context.columnManager.columns)"icon"!==e.type&&(e.headerCell.span.classList.add("sort"),e.headerCell.span.addEventListener("click",this.handleSort),this.headerCells.push(e.headerCell))}remoteParams=e=>(e.sort=this.currentSortColumn,e.direction=this.currentDirection,e);updateSortState(e){this.currentSortColumn=e.name,this.currentDirection=e.directionNext.valueOf(),this.currentType=e.type,e.isCurrentSort||this.resetSort(),e.setSortFlag()}handleSort=async e=>{const t=e.currentTarget.context;this.updateSortState(t),await this.context.events.trigger("render")};resetSort(){const e=this.headerCells.find(e=>e.isCurrentSort);void 0!==e&&e.removeSortFlag()}renderLocal=()=>{this.currentSortColumn&&this.context.persistence.data.sort((e,t)=>this.sorters[this.currentType](e[this.currentSortColumn],t[this.currentSortColumn],this.currentDirection))}}SortModule.moduleName="sort";class TableData extends GridCore{constructor(e,t){super(e,t),TableData.defaultOptions.enableFilter&&this.addModules(FilterModule),TableData.defaultOptions.enableSort&&this.addModules(SortModule),this.settings.rowCountId&&this.addModules(RowCountModule),this.settings.refreshableId&&this.addModules(RefreshModule),this.settings.csvExportId&&this.addModules(CsvModule)}}TableData.defaultOptions={enableSort:!0,enableFilter:!0};
